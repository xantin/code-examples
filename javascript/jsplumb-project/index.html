<!DOCTYPE html>
<html lang="en">
<head>
    <title>Tool</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="assets/css/styles.css" rel="stylesheet">
    <style type="text/css">
        circle {
            cx: 10;
            cy: 10;
            r: 5;
            /*fill: black;
            stroke: grey;*/
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <header class="row">
        <div class="col-sm-3 logo">

        </div>
    </header>
    <div class="row">
        <!-- multiple columns -->
    </div><!-- closing .row -->


    <div id="diagram-container">

        <div id="ex">
            Select Application
            <div id="prod">Prod
                <!-- <div id="grid-item-height-right-prod"></div> -->
            </div>
            <div id="test">Test
                <!-- <div id="grid-item-height-right-test"></div> -->
            </div>
            <div id="dev">Dev
                <!-- <div id="grid-item-height-right-dev"></div> -->
            </div>
        </div>

        <div id="timetable"></div>
        <div id="storage">
            Storage
        </div>
        <div id="netAppPlatform">
            NetApp cluster
        </div>
        <div id="frontendlabel">
            Front End
        </div>
        <div id="VMwarePlatform1">
            VMware cluster
        </div>
        <div id="applicationDelivery">
            Application Delivery
        </div>
        <div id="apcPlatform">
            Application Delivery Controller
        </div>
        <div id="backendlabel">
            Back end
        </div>
        <div id="VMwarePlatform2">
            VMware cluster
        </div>
    </div>

    <div id="catalogue-contents"></div>

    <form action="">
        <label><input type="checkbox" name="area" id="area3" value="application-delivery"> Application Delivery</label>
        <label><input type="checkbox" name="area" id="area2" value="front-end"> Frontend</label>
        <label><input type="checkbox" name="area" id="area4" value="back-end"> Backend</label>
        <label><input type="checkbox" name="area" id="area1" value="storage"> Storage</label>
    </form>

    <button id="get_json_data" type="button" class="btn-info" style="float:right;margin-top:5em">Export JSON
        data
    </button>

    <div class="row">
        <!-- multiple columns -->
    </div><!-- closing .row -->
</div><!-- closing .container -->

<!-- JavaScript -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/TweenMax.min.js"></script>
<!--TweenLite/TweenMax GSAP-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/CSSPlugin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/easing/EasePack.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenLite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TimelineLite.min.js"></script>

<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/RoundPropsPlugin.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.0.7/jsPlumb.min.js"></script>
<script type="text/javascript" src="assets/js/custom.js"></script>
<script>




    //Animation
    var tl = new TimelineLite({paused: true});

    tl.to("#prod", 1, {css: {opacity: 1}}, "-=0")
            .to("#test", 1, {css: {opacity: 1}}, "-=0")
            .to("#dev", 1, {css: {opacity: 1}}, "-=0")
    ;

    $("#ex").click(function () {
        tl.play();
    });

    //Catalogue Items



    $(function () {
        jsPlumb.ready(function () {



            var sourcePositions = {};
            // counts the number of elements per class
            var classCounter = {
                'db': 0,
                'dbvm': 0,
                'vm': 0,
                'st': 0,
                'service-endpoint': 0
            };

            var allowedDropZones = [
                'dev',
                'test',
                'prod'
            ];

            // config for dynamic connecttions when sub containers are dragged out of parent
            var dynEndpoint = {
                isSource: true,
                anchor: "Top",
                connector: ["Straight"],
                detachable: false,
                connectorStyle: {
                    lineWidth: 3,
                    fillStyle: "orange",
                    lineStyle: "orange",
                    strokeStyle: "orange",
                    stroke: "orange",
                    strokeWidth: 10
                },
                endpointStyle: {
                    fillStyle: "orange",
                    outlineColor: "orange"
                }
            };

            // html element to render jsplumb into
            var $container = $('#catalogue-contents');
            var jsp = jsPlumb.getInstance();

            var get_json_data = function(){
                var connections = [];
                $.each(jsp.getConnections(), function (idx, connection) {
                    connections.push({
                        connectionId: connection.id,
                        pageSourceId: connection.sourceId,
                        pageTargetId: connection.targetId,
                        anchors: $.map(connection.endpoints, function (endpoint) {

                            return [[endpoint.anchor.x,
                                endpoint.anchor.y,
                                endpoint.anchor.orientation[0],
                                endpoint.anchor.orientation[1],
                                endpoint.anchor.offsets[0],
                                endpoint.anchor.offsets[1]]];

                        })
                    });
                });
                console.log(connections);
//                window.location.href = "data:text/plain;charset=UTF-8,Hello World";
            };
            $('#get_json_data').on('click', function(){
                get_json_data();
            });


            /**
             * factory method for creating new elements
             * @param className type of new element
             * @param endpointOptionsList list of endpoints
             * @param isResource if provided box is cloneable
             * @return html div element
             */
            function createBox(className, endpointOptionsList, isResource) {
                // generate unique box id from system milliseconds and number of children
                this.boxNumber = $container.children().size() + Date.now();
                // get class index
                this.classCounter = classCounter[className];
                // wrap as id attribute
                this.boxId = `box${this.boxNumber}`;
                // create div element
                this._render = function () {
                    var content = className + ' ' + this.classCounter;
                    var isClonable = (typeof isResource == "undefined") ? '' : ' isClonable';
                    return `<div id="${boxId}" class="${className}${isClonable}"><span>${content}</span></div>`;
                };

                // append new box to container
                $container.append(this._render());

                // add right click listener to new box for deletion
                $('#' + this.boxId).contextmenu(function (ev) {
                    // stop event from bubbling up
                    ev.preventDefault();
                    ev.stopPropagation();
                    // prompt user
                    if (confirm("Do you really want to delete this element?\nThis cannot be reversed.")) {
                        // get parent container id (if it belongs to a container)
                        var targetDbId = $(this).attr('data-targetdb');
                        var elemId = $(this).attr('id');
                        // remove all connections
                        jsp.detachAllConnections($(`#${elemId}`));
                        // remove all endpoiints
                        jsp.removeAllEndpoints($(`#${elemId}`));
                        // remove box itself
                        $(this).remove();
                        // if it belonged to a parent container
                        if (typeof targetDbId != "undefined") {
                            // height of dbvm elements
                            var elemHeight = $('.dbvm').height() + 2;
                            // update size of parent container
                            upDateDbBox($('#' + targetDbId), elemHeight);
                        }
                    }
                });

                // register onclick handler on box text which is contained inside a span element
                $('#' + this.boxId + ' span').on('click', function (eve) {
                    // stop event from bubbling up
                    eve.preventDefault();
                    eve.stopPropagation();
                    // pompt user to edit text contained in the span element
                    var newVal = prompt('Please modify text', $(this).html());
                    if (newVal != null) { // if user hiit 'ok'
                        $(this).html(newVal); // update span contents
                    }
                })

                // register drag handler on box element
                jsp.draggable(this.boxId, {
                    grid: [25, 25],
                    helper: 'clone', // clone to access the dragable copy
                    start: function (e, ui) { // drag init
                        e.e.preventDefault();
                        e.e.stopPropagation();
                        // get drag element from event copy
                        var elem = $(e.drag.getDragElement());
                        var hZi = getHighestZIndex();
                        elem.css('z-index', (hZi + 1)); // put abovde all elements while dragging
                    },
                    stop: function (e, ui) { // add drag-stop listener invoked on mouseup

                        e.e.preventDefault();
                        e.e.stopPropagation();
                        var elem = $(e.drag.getDragElement());
                        var iso = isOverResourceArea(elem); // are we dropping over a resource area?
                        if (false === iso && false === isOverStackElement(elem)) { // if over resource and not over db-element reverse the dragging
                            // get drag element from event
                            var mainClass = elem.attr('class').split(' ')[0];
                            // move back to initial position
                            elem.css({'top': sourcePositions[mainClass].top, 'left': sourcePositions[mainClass].left});
                            var bid = elem.attr('id');
                            // repaont endpoimts
                            $('#' + bid).find('._jsPlumb_endpoint_anchor_').each(function (i, e) {
                                if ($(e).hasClass("connect"))
                                    jsp.repaint($(e).parent());
                                else
                                    jsp.repaint($(e));
                            });
                            jsp.recalculateOffsets(bid);
                            jsp.repaintEverything();
                            console.log('dragg');
                            var connections = [];
                            $.each(jsPlumb.getConnections(), function (idx, connection) {
                                connections.push({
                                    connectionId: connection.id,
                                    pageSourceId: connection.sourceId,
                                    pageTargetId: connection.targetId,
                                    anchors: $.map(connection.endpoints, function (endpoint) {

                                        return [[endpoint.anchor.x,
                                            endpoint.anchor.y,
                                            endpoint.anchor.orientation[0],
                                            endpoint.anchor.orientation[1],
                                            endpoint.anchor.offsets[0],
                                            endpoint.anchor.offsets[1]]];

                                    })
                                });
                            });
//                            console.log('connections');
//                            console.log(connections);
                            return false;
                        } // end not ovder resource area
                        // reset z-index to normal
                        elem.css('z-index', 'auto');
                        // get elements class
                        var elemClass = elem.attr('class') + '';
                        // if it containes isClonable -> make a copy
                        if (elemClass.indexOf('isClonable') > -1) {
                            // remove isClonable from dropped element so that we don't produce another copy on re-draghing
                            elem.removeClass('isClonable');
                            // create new box with same class
                            makeBox(elemClass, true);
                        }
                        // if we are dealing with a dbvm element ...
                        if (elemClass.indexOf('dbvm') > -1) {
                            var elemHeight = elem.height() + 2;
                            // loop over all db container to check and update state
                            $('.db').each(function () {
                                var dbElem = $(this);
                                // if our dbvm box is either ovder a db box or is connected to this db box ...
                                if (collision(dbElem, elem) || elem.attr('data-targetdb') == dbElem.attr('id')) {
                                    // update db element
                                    updateDbElem(dbElem, elem, elemHeight);
                                }
                            });
                        } // end if
                    } // end stop
                });

                // add endpoints from options to box elements
                if (endpointOptionsList) endpointOptionsList.forEach(options => jsp.addEndpoint($('#'+this.boxId), options))

                return this;
            }

            // add default boxes
            for (var cl in classCounter) {
                var bx = makeBox(cl, true);
                var bxElem = $('#' + bx.boxId);
                sourcePositions[cl] = {'top': bxElem.css('top'), 'left': bxElem.css('left')};
            }

            function isOverResourceArea(elem) {
                for (var i = 0; i < allowedDropZones.length; i++) {
                    if (collision(elem, $('#' + allowedDropZones[i]))) {
                        return true;
                    }
                }
                return false;
            }

            function isOverStackElement(elem) {
                var res = false;
                $('.db').each(function () {
                    var dbElem = $(this);
                    // if our dbvm box is either ovder a db box or is connected to this db box ...
                    if (collision(dbElem, elem) && elem.attr('id') != dbElem.attr('id')) {
                        res = true;
                    }
                });
                return res;
            }

            /**
             * update db container
             * @param dbe the db container
             * @param dbvm the dbvm element that was just dropped
             * @param eHeight height of dbvm element
             * @return done state flag
             */
            function updateDbElem(dbe, dbvm, eHeight) {
                var done = 0;
                // if dbvm element is over the db container ...
                if (collision(dbe, dbvm)) {
                    var innerState = 0;
                    // if the dbvm element has already connections to the db container - remove them
                    if (typeof dbvm.attr('data-dbconnected') != "undefined"
                            && dbvm.attr('data-targetdb') == dbe.attr('id')) {
                        jsp.detachAllConnections($(`#${dbvm.attr('id')}`));
                        // and remove the connected attribute
                        dbvm.removeAttr('data-dbconnected');
                        done++;
                    }
                    // if the dbvm is not yet inside the db element add it
                    if (dbe.find('#' + dbvm.attr('id')).length < 1) {
                        // put the new box's position at the end of the db container
                        dbvm.css({
                            'position': 'absolute',
                            'left': '10px', 'top': ((dbe.find('div').length + 1) * (eHeight + 5)) + 'px'
                        });
                        // set the target db id for this dbvm box
                        dbvm.attr('data-targetdb', dbe.attr('id'));
                        // add the box the the db element
                        dbvm.appendTo(dbe);
                        // update the db box
                        upDateDbBox(dbe, eHeight + 5);
                        innerState = 1;
                        done++;
                    }
                    if (innerState < 1) {
                        // if the element is already inside the box just update the db element
                        upDateDbBox(dbe, eHeight);
                    }
                }
                // if we move a box out of its parent db element and it does not have connectors yet
                // add connectors to the dbvm element
                if (done < 1 && !collision(dbe, dbvm) && typeof dbvm.attr('data-dbconnected') == "undefined") {
                    // add connected attribute to dbvm elem
                    dbvm.attr('data-dbconnected', 'yes');
                    // update db elem
                    upDateDbBox(dbe, eHeight + 5);
                    // connect dbvm elem with db elem
                    jsp.connect({
                        source: dbvm.attr('id'), target: dbe.attr('id'), anchor: "TopCenter",
                        endpointStyle: dynEndpoint.endpointStyle,
                        connectorStyle: dynEndpoint.connectorStyle
                    });
                    done++;
                }

                return done;
            };

            /**
             * update a db element
             * @param dbe the db element to update
             * @param eHeight height of element
             */
            function upDateDbBox(dbe, eHeight) {
                var posCount = 1; // count children rows in db element
                dbe.find('div').each(function (idx) { // loop over all div elements inside db element
                    if (typeof $(this).attr('data-dbconnected') == "undefined") { // if div element has no connections(is inside the db element)
                        $(this).css({
                            'position': 'absolute',
                            'left': '10px', 'top': (posCount * eHeight) + 'px'
                        }); // update its position
                        posCount++; // increase children row count
                    }
                });

                /*********************** NOTE ******************************
                 * if you comment following lines the db elem will not be resized to height.
                 * the background of the db element will be transparent for the
                 * contained dbvm elements.
                 * if you uncomment following lines db element will expand in height
                 * depending on number of currently contained dbvm elements
                 */
                var eh = (posCount > 1) ? ((posCount * eHeight) + 2) : $('.vm').height();
                dbe.css('height', eh + 'px');

            }

            /**
             * simple collision detection on mouse over
             * @param $div1 first element
             * @param $div2 second element
             * @return boolean
             */
            function collision($div1, $div2) {
                // get dimensiions of both containers
                var x1 = $div1.offset().left;
                var y1 = $div1.offset().top;
                var h1 = $div1.outerHeight(true);
                var w1 = $div1.outerWidth(true);
                var b1 = y1 + h1;
                var r1 = x1 + w1;
                var x2 = $div2.offset().left;
                var y2 = $div2.offset().top;
                var h2 = $div2.outerHeight(true);
                var w2 = $div2.outerWidth(true);
                var b2 = y2 + h2;
                var r2 = x2 + w2;
                // check if outside - return false
                if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) return false;
                return true; // inside -> true
            }

            /**
             * just a very high z-index to add to
             * elements that are being dragged to
             * make sure they are always on top -> visible
             * @return int
             */
            function getHighestZIndex() {
                return 10000;
            }

            /**
             * factory method to create new boxes depending on class name
             * @param className full classname with all components
             * @param make this box a clonable resource
             * @return jsplumb element
             */
            function makeBox(className, isResource) {
                // the first classname determines the element type
                var className = className.split(' ')[0];
                // increase class counter for the new name of the element
                classCounter[className]++;
                switch (className) { // different class types
                    case 'db':
                        // call factory method
                        return createBox(className, [{
                            isSource: true,
                            anchor: "Right",
                            connector: ["Straight"],
                            maxConnections: -1,
                            connectorStyle: {
                                lineWidth: 3,
                                strokeStyle: "blueviolet"
                            },
                            endpointStyle: {
                                fillStyle: "blueviolet",
                                outlineColor: "blueviolet"
                            }
                        }, {
                            isTarget: true,
                            anchor: "Left",
                            connector: ["Straight"],
                            endpointStyle: {
                                fillStyle: "blueviolet",
                                outlineColor: "blueviolet"
                            }
                        }], isResource);
                    case 'st':
                        return createBox(className, [{
                            isTarget: true,
                            anchor: "Left",
                            connector: ["Straight"],
                            endpointStyle: {
                                fillStyle: "DodgerBlue",
                                outlineColor: "DodgerBlue"
                            }
                        }], isResource);
                    case 'vm':
                        return createBox(className, [{
                            isSource: true,
                            anchor: "Right",
                            connector: ["Straight"],
                            connectorStyle: {
                                lineWidth: 3,
                                strokeStyle: "green"
                            },
                            endpointStyle: {
                                fillStyle: "green",
                                outlineColor: "green"
                            }
                        }, {
                            isTarget: true,
                            anchor: "Left",
                            connector: ["Straight"],
                            endpointStyle: {
                                fillStyle: "green",
                                outlineColor: "green"
                            }
                        }], isResource);
                    case 'service-endpoint':
                        return createBox(className, [{
                            isSource: true,
                            anchor: "Right",
                            maxConnections: -1,
                            connector: ["Straight"],
                            connectorStyle: {
                                lineWidth: 3,
                                strokeStyle: "DodgerBlue"
                            },
                            endpointStyle: {
                                fillStyle: "DodgerBlue",
                                outlineColor: "DodgerBlue"
                            }
                        }], isResource);
                    case 'dbvm':
                        return createBox(className, [], isResource);

                } // end switch
            } // end makeBox
        }); // doc ready

    }); // init

    // Checkboxes
    $(function () {
        $('#area1').click(function () {
            $("#storage").toggle(this.checked);
            $("#netAppPlatform").toggle(this.checked);
        });
    });

    $(function () {
        $('#area2').click(function () {
            $("#frontendlabel").toggle(this.checked);
            $("#VMwarePlatform1").toggle(this.checked);
        });
    });

    $(function () {
        $('#area3').click(function () {
            $("#applicationDelivery").toggle(this.checked);
            $("#apcPlatform").toggle(this.checked);
        });
    });

    $(function () {
        $('#area4').click(function () {
            $("#backendlabel").toggle(this.checked);
            $("#VMwarePlatform2").toggle(this.checked);
        });
    });

</script>
</body>
</html>

